<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma Bibliothèque</title>
  <link rel="stylesheet" href="style/style.css">
  <link rel="stylesheet" href="style/theme.css">
  <link rel="stylesheet" href="style/typo.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text:ital@0;1&family=Quicksand:wght@500&display=swap"
    rel="stylesheet">
</head>

<body>
  <main>
    <h1>📚 Ma Bibliothèque</h1>
    <section class="add-form">
      <input type="text" id="title" placeholder="Titre">
      <input type="number" id="pages" placeholder="Pages (max)">
      <input type="text" id="cover" placeholder="URL de la couverture">
      <input type="text" id="author" placeholder="Auteur">
      <select id="type">
        <option value="livre">📖 Livre</option>
        <option value="manga">📘 Manga</option>
      </select>
      <button id="addBtn">Ajouter</button>
    </section>


    <section class="sort-options">
      <!-- Trier par note / auteur… -->
      <label for="sortCriteria">Trier par :</label>
      <select id="sortCriteria">
        <option value="rating">Note</option>
        <option value="author">Auteur</option>
      </select>
      <select id="sortOrder">
        <option value="desc">Décroissant</option>
        <option value="asc">Croissant</option>
      </select>

      <!-- Nouveau filtre par année -->
      <label for="yearSelect">Filtrer par année :</label>
      <select id="yearSelect">
        <option value="all">Toutes</option>
      </select>

      <label for="themeSelect">Thème :</label>
      <select id="themeSelect">
        <option value="nature">Nature</option>
        <option value="vintage">Vintage</option>
        <option value="the">Thé</option>
        <option value="romance">Romance</option>
        <option value="solaire">Solaire</option>
        <option value="fantastique">Fantastique</option>
      </select>
    </section>

    <section>
      <h2 class="collapsible">
        📚 Mes envies <span class="toggle-icon">▼</span>
      </h2>
      <div id="enviesList" class="grid"></div>
    </section>

    <section>
      <h2 class="collapsible">
        📖 Mes lectures <span class="toggle-icon">▼</span>
      </h2>
      <div id="lectureList" class="grid"></div>
    </section>

    <section>
      <h2 class="collapsible">
        ✅ Livres lus <span class="toggle-icon">▼</span>
      </h2>
      <div id="finishedList" class="grid"></div>
    </section>

    <section class="stats">
      <p><strong>📘 Mangas lus :</strong> <span id="mangaCount">0</span></p>
      <p><strong>📖 Livres lus :</strong> <span id="bookCount">0</span></p>
      <p><strong>Total pages lues :</strong> <span id="pageCount">0</span></p>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // — Références DOM —
      const addBtn = document.getElementById('addBtn');
      const enviesList = document.getElementById('enviesList');
      const lectureList = document.getElementById('lectureList');
      const finishedList = document.getElementById('finishedList');

      const mangaCount = document.getElementById('mangaCount');
      const bookCount = document.getElementById('bookCount');
      const pageCount = document.getElementById('pageCount');

      const sortCriteria = document.getElementById('sortCriteria');
      const sortOrder = document.getElementById('sortOrder');
      const yearSelect = document.getElementById('yearSelect');
      const themeSelect = document.getElementById('themeSelect');

      // — Chargement / sauvegarde —
      let library = [];
      function saveLibrary() {
        localStorage.setItem('library', JSON.stringify(library));
      }
      function loadLibrary() {
        library = JSON.parse(localStorage.getItem('library') || '[]')
          .map(item => ({
            // normalisation des anciennes entrées
            author: item.author || '',
            rating: item.rating || 0,
            read: item.read || 0,
            comment: item.comment || '',
            readDate: item.readDate || '',
            ...item
          }));
        populateYearFilter();
        render();
      }

      // — Filtre années —
      function getUniqueYears() {
        const years = new Set();
        library.forEach(({ readDate }) => {
          if (readDate) years.add(readDate.substring(0, 4));
        });
        return Array.from(years).sort();
      }
      function populateYearFilter() {
        yearSelect.innerHTML = '<option value="all">Toutes</option>';
        getUniqueYears().forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        });
      }

      // — Tri —
      function sortLibrary(criteria, order) {
        library.sort((a, b) => {
          if (criteria === 'rating') {
            const ra = a.rating, rb = b.rating;
            return order === 'asc' ? ra - rb : rb - ra;
          }
          if (criteria === 'author') {
            const A = (a.author || '').toLowerCase();
            const B = (b.author || '').toLowerCase();
            return order === 'asc' ? A.localeCompare(B) : B.localeCompare(A);
          }
          return 0;
        });
      }

      // — Affichage / stats —
      function render() {
        enviesList.innerHTML = '';
        lectureList.innerHTML = '';
        finishedList.innerHTML = '';

        let mangasFinished = 0, booksFinished = 0, pagesTotal = 0;
        const yearFilter = yearSelect.value;
        sortLibrary(sortCriteria.value, sortOrder.value);

        library.forEach((item, idx) => {
          // filtre année
          if (yearFilter !== 'all') {
            const y = item.readDate ? item.readDate.substring(0, 4) : '';
            if (y !== yearFilter) return;
          }

          // création carte
          const card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('data-type', item.type);
          card.innerHTML = `
        <img src="${item.cover}" alt="">
        <h3>${item.title}</h3>
        <p>Auteur : ${item.author}</p>
        <p>Pages : ${item.read}/${item.pages}</p>
        <input type="number" min="0" max="${item.pages}" value="${item.read}"
               data-index="${idx}" class="progressInput">
        <input type="month" value="${item.readDate || ''}" data-index="${idx}" class="readDate">
        <div class="rating" data-index="${idx}">
          ${[1, 2, 3, 4, 5].map(i =>
            `<span class="star ${i <= item.rating ? 'filled' : ''}" data-value="${i}">&#9733;</span>`
          ).join('')}
        </div>
        <button data-comment-toggle="${idx}" class="commentBtn">💬 Commentaire</button>
        <div id="comment-${idx}" class="commentSection" style="display:none;">
          <textarea data-index="${idx}" class="commentInput"
                    placeholder="Tes pensées…">${item.comment}</textarea>
          <button data-comment-save="${idx}" class="saveCommentBtn">💾 Sauvegarder</button>
        </div>
        <button data-delete="${idx}" class="deleteBtn">🗑️ Supprimer</button>
      `;

          // classification + stats
          if (item.read === 0) {
            enviesList.appendChild(card);
          } else if (item.read < item.pages) {
            lectureList.appendChild(card);
          } else {
            finishedList.appendChild(card);
            if (item.type === 'manga') mangasFinished++;
            else booksFinished++;
            pagesTotal += item.read;
          }
        });

        // mise à jour stats
        mangaCount.textContent = mangasFinished;
        bookCount.textContent = booksFinished;
        pageCount.textContent = pagesTotal;

        addEventListeners();
      }

      // — Interactions dynamiques —
      function addEventListeners() {
        // progression
        document.querySelectorAll('.progressInput').forEach(input => {
          input.onchange = e => {
            const i = e.target.dataset.index;
            library[i].read = +e.target.value;
            saveLibrary();
            render();
          };
        });
        // date de lecture
        document.querySelectorAll('.readDate').forEach(input => {
          input.onchange = e => {
            const i = e.target.dataset.index;
            library[i].readDate = e.target.value;
            saveLibrary();
          };
        });
        // notes
        document.querySelectorAll('.star').forEach(star => {
          star.onclick = e => {
            const i = e.target.closest('.rating').dataset.index;
            library[i].rating = +e.target.dataset.value;
            saveLibrary();
            render();
          };
        });
        // commentaires
        document.querySelectorAll('.commentBtn').forEach(btn => {
          btn.onclick = e => {
            const i = e.target.dataset.commentToggle;
            const sec = document.getElementById(`comment-${i}`);
            sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
          };
        });
        document.querySelectorAll('.saveCommentBtn').forEach(btn => {
          btn.onclick = e => {
            const i = e.target.dataset.commentSave;
            const ta = document.querySelector(`.commentInput[data-index="${i}"]`);
            library[i].comment = ta.value;
            saveLibrary();
            btn.textContent = '✅ Sauvé';
            setTimeout(() => btn.textContent = '💾 Sauvegarder', 1000);
          };
        });
        // suppression
        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.onclick = e => {
            library.splice(e.target.dataset.delete, 1);
            saveLibrary();
            populateYearFilter();
            render();
          };
        });
      }

      // — Ajout de livre —
      addBtn.onclick = () => {
        const title = document.getElementById('title').value.trim();
        const pages = +document.getElementById('pages').value;
        const cover = document.getElementById('cover').value.trim();
        const author = document.getElementById('author').value.trim();
        const type = document.getElementById('type').value;
        if (!title || !pages || !cover || !author) {
          return alert('Tous les champs sont requis.');
        }
        library.push({
          title, pages, read: 0, cover, author, type,
          readDate: '', rating: 0, comment: ''
        });
        saveLibrary();
        populateYearFilter();
        render();

        // reset
        ['title', 'pages', 'cover', 'author'].forEach(id => document.getElementById(id).value = '');
      };

      // — Écouteurs de tri & filtre & thème —
      sortCriteria.onchange = render;
      sortOrder.onchange = render;
      yearSelect.onchange = render;

      // thème
      const savedTheme = localStorage.getItem('theme') || 'nature';
      document.body.className = savedTheme;
      themeSelect.value = savedTheme;
      themeSelect.onchange = () => {
        document.body.className = themeSelect.value;
        localStorage.setItem('theme', themeSelect.value);
      };

      // Initialisation
      loadLibrary();
      //  — Collapsibles sections —
      document.querySelectorAll('h2.collapsible').forEach(header => {
        // Initialisation : on part de sections ouvertes
        header.classList.remove('collapsed');
        const list = header.nextElementSibling;
        list.style.display = 'grid';

        header.addEventListener('click', () => {
          header.classList.toggle('collapsed');
          list.style.display = header.classList.contains('collapsed') ? 'none' : 'grid';
        });
      });
    });
  </script>
</body>

</html>